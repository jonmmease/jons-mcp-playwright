/**
 * Utilities for resolving element refs to Playwright elements
 *
 * Refs are identifiers like "e493" that Playwright MCP assigns to elements
 * in accessibility snapshots. These refs are generated by Playwright's
 * accessibility snapshot and can be used to locate elements via the
 * special `aria-ref` selector.
 */

/**
 * Resolves a ref string to a Playwright Locator.
 *
 * @param {import('playwright-core').Page} page - The Playwright page object
 * @param {string} ref - The ref string (e.g., "e493")
 * @returns {Promise<import('playwright-core').Locator>} A Playwright Locator for the element
 * @throws {Error} If the ref is not found in the current page
 *
 * @example
 * const locator = await getElementByRef(page, 'e493');
 * await locator.click();
 */
export async function getElementByRef(page, ref) {
  if (!ref || typeof ref !== 'string') {
    throw new Error('Invalid ref: must be a non-empty string');
  }

  try {
    // Use the aria-ref selector that Playwright MCP uses internally
    // This is the same approach used in tab.js refLocators() method
    const locator = page.locator(`aria-ref=${ref}`);

    // Verify the locator can be resolved by attempting to resolve its selector
    // This will throw if the ref is not found
    if (locator._resolveSelector) {
      await locator._resolveSelector();
    } else {
      // Fallback: check if the element exists by counting
      const count = await locator.count();
      if (count === 0) {
        throw new Error('Element not found');
      }
    }

    return locator;
  } catch (e) {
    throw new Error(
      `Ref "${ref}" not found in the current page snapshot. ` +
      `The page may have changed since the snapshot was taken. ` +
      `Try capturing a new snapshot with browser_snapshot().`
    );
  }
}

/**
 * Resolves multiple refs to Playwright Locators in parallel.
 *
 * @param {import('playwright-core').Page} page - The Playwright page object
 * @param {string[]} refs - Array of ref strings
 * @returns {Promise<import('playwright-core').Locator[]>} Array of Playwright Locators
 * @throws {Error} If any ref is not found
 *
 * @example
 * const [startLocator, endLocator] = await getElementsByRefs(page, ['e100', 'e200']);
 * await startLocator.dragTo(endLocator);
 */
export async function getElementsByRefs(page, refs) {
  return Promise.all(refs.map(ref => getElementByRef(page, ref)));
}

/**
 * Checks if a ref exists in the current page without throwing an error.
 *
 * @param {import('playwright-core').Page} page - The Playwright page object
 * @param {string} ref - The ref string
 * @returns {Promise<boolean>} True if the ref exists, false otherwise
 *
 * @example
 * if (await refExists(page, 'e493')) {
 *   const locator = await getElementByRef(page, 'e493');
 *   await locator.click();
 * }
 */
export async function refExists(page, ref) {
  try {
    await getElementByRef(page, ref);
    return true;
  } catch {
    return false;
  }
}
